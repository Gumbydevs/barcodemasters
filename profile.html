<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Masters - Profile</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="assets/styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Add this */
        }

        footer {
            width: 100%;
            padding: 1rem;
            background: inherit;
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            position: static;
            bottom: 0;
            box-sizing: border-box;
            
        }

        .profile-container {
            width: 100%;
            max-width: 100%;
            padding: 1rem;
            box-sizing: border-box;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            
        }

        .profile-layout {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .logo-container {
            width: 100%;
            max-width: 200px;
            display: flex;
            justify-content: center;
            padding: 1rem;
            box-sizing: border-box;
        }

        .logo-container img {
            max-width: 100%;
            height: auto;
            object-fit: contain;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .avatar-placeholder {
            width: 64px;
            height: 64px;
            background: #666;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            background-size: cover; /* Add this */
            background-position: center; /* Add this */
        }

        .stats-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .stat-box {
            text-align: center;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tooltip-box {
            margin: 1rem auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            text-align: center;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 90%;
        }

        .navigation-grid {
            display: grid;
            gap: 1rem;
            width: 90%;
            max-width: 1000px;
            padding: 1rem;
            margin: 0 auto;
            grid-template-columns: repeat(4, 1fr);
        }

        .nav-button {
            padding: 1rem;
            border-radius: 8px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #34495e, #2980b9);
        }

        .nav-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #logoutButton {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
        }

        #logoutButton:hover {
            background: linear-gradient(135deg, #d35400, #e67e22);
        }

        .mvp-monster {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mvp-monster h3 {
            margin: 0;
            font-size: 0.9rem;
            color: #ffd700;
        }

        .mvp-monster p {
            margin: 0.2rem 0;
            font-size: 0.8rem;
        }

        /* Light mode specific styles */
        body:not(.dark-mode) .nav-button {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
        }

        body:not(.dark-mode) .nav-button:hover {
            background: linear-gradient(135deg, #34495e, #2980b9);
        }

        /* Desktop Specific Styles */
        @media screen and (min-width: 1024px) {
            .navigation-grid {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(3, auto);
                max-width: 800px;
                margin: 2rem auto;
            }

            .nav-button {
                min-width: 150px;
            }

            /* Position logout button in the center of the last row */
            .nav-button:last-child {
                grid-column: 2 / 4;
            }
        }

        /* Tablet styles */
        @media (max-width: 1023px) and (min-width: 769px) {
            .navigation-grid {
                grid-template-columns: repeat(3, 1fr);
                max-width: 700px;
            }
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            .profile-layout {
                flex-direction: column;
                text-align: center;
                padding: 0.5rem;
                gap: 1rem;
                margin-bottom: 10px; /* margin below profile container */
            }

            .logo-container {
                padding: 0.5rem;
                margin-top: 2rem;
            }

            .player-info {
                flex-direction: column;
                width: 90%;
                margin: 0 auto;
                padding: 0.75rem;
            }

            .navigation-grid {
                grid-template-columns: repeat(2, 1fr);
                padding: 0.5rem;
                gap: 0.75rem;
                width: 90%;
                margin: 0 auto;
            }

            .nav-button {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .tooltip-box {
                width: 90%;
                margin: 1rem auto;
                padding: 0.75rem;
            }

            .stats-container {
                flex-wrap: wrap;
                justify-content: center;
            }

            .mvp-monster {
                width: 100%;
                box-sizing: border-box;
            }
        }

        @media screen and (max-width: 428px) {
            .profile-container {
                padding: 0.5rem;
            }

            .logo-container {
                margin-top: 3rem;
            }

            .navigation-grid {
                width: 95%;
            }

            .nav-button {
                padding: 0.6rem;
                font-size: 0.85rem;
            }

            .player-info {
                width: 95%;
            }
        }

        .rename-button {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-top: 1rem;
        }

        .rename-button:hover {
            background: linear-gradient(135deg, #34495e, #2980b9);
        }

        .upload-button {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-top: 1rem;
        }

        .upload-button:hover {
            background: linear-gradient(135deg, #34495e, #2980b9);
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="dark-mode-toggle">🌙</button>

    <div class="profile-container">
        <div class="profile-layout">
            <!-- Logo -->
            <div class="logo-container">
                <img src="assets/images/BarcodeLogo1.PNG" alt="Barcode Masters Logo">
            </div>

            <!-- Player Info -->
            <div class="player-info">
                <div class="avatar-placeholder" id="avatarPlaceholder">
                    👤
                </div>
                <input type="file" id="profileImageInput" style="display: none;" accept="image/*">
                <div class="player-details">
                    <h2 id="userName">Loading...</h2>
                    <div class="stats-container">
                        <div class="stat-box">
                            <div>Wins</div>
                            <strong id="playerWins">0</strong>
                        </div>
                        <div class="stat-box">
                            <div>Losses</div>
                            <strong id="playerLosses">0</strong>
                        </div>
                        <div class="stat-box">
                            <div>Total Monsters</div>
                            <strong id="totalMonsters">0</strong>
                        </div>
                        <div class="stat-box">
                            <div>Highest Level</div>
                            <strong id="highestLevel">0</strong>
                        </div>
                        <div class="stat-box">
                            <div>Unique Types</div>
                            <strong id="uniqueTypes">0</strong>
                        </div>
                        <div class="stat-box">
                            <div>Completion</div>
                            <strong id="completionPercentage">0%</strong>
                        </div>
                    </div>
                    <!-- MVP Monster Section -->
                    <div class="mvp-monster">
                        <h3>⭐ MVP Monster</h3>
                        <p id="mvpMonsterName">Loading MVP...</p>
                        <p>Wins: <span id="mvpMonsterWins">0</span> | XP: <span id="mvpMonsterXP">0</span></p>
                    </div>
                    <button class="rename-button" id="renamePlayerButton">Rename Player</button>
                    <button class="upload-button" id="uploadImageButton">Change Profile Photo</button>
                </div>
            </div>
        </div>

        <!-- Game Tip Tooltips -->
        <div class="tooltip-box" id="gameTip">
            Loading tip...
        </div>

        <!-- Navigation Buttons -->
        <div class="navigation-grid">
            <button class="nav-button" onclick="location.href='dna-extractor.html'">DNA Extractor</button>
            <button class="nav-button" onclick="location.href='monster-collection.html'">Monster Collection</button>
            <button class="nav-button" onclick="location.href='train-monster.html'">Train Monster</button>
            <button class="nav-button" onclick="location.href='select-monster.html'">Battle Monsters</button>
            <button class="nav-button" onclick="location.href='monster-index.html'">Monster Index</button>
            <button class="nav-button" onclick="location.href='leaderboard.html'">Leaderboard</button>
            <button class="nav-button" onclick="location.href='help.html'">Help</button>
            <button class="nav-button" id="logoutButton">Logout</button>
        </div>

        <!-- Error Message -->
        <p id="errorMessage" style="color: red; display: none;"></p>
    </div>

    <!-- Version Number -->
    <footer>
        <p>Version: <span id="versionNumber">1.0.04</span></p>
        <p>&copy; 2025 Barcode Masters | <a href="changelog.html">Change Log</a> | <a href="privacy-policy.html">Privacy Policy</a></p> 
    </footer>

    <!-- Firebase SDK (Modules) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDoIWAIUt4HC1RcNmdfXozEr0NG65GO63s",
            authDomain: "barcodemasters-b4b9b.firebaseapp.com",
            projectId: "barcodemasters-b4b9b",
            storageBucket: "barcodemasters-b4b9b.firebasestorage.app",
            messagingSenderId: "827677074735",
            appId: "1:827677074735:web:3bace3d02034348bc82dda",
            measurementId: "G-14YTBBLTPZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Game tips array
        const gameTips = [
            "Scan codes to find powerful monsters!",
            "Scanning codes is an artform. It takes practice to get good results everytime!",
            "Most QR codes will contain DNA and scanable monsters.",
            "Not all barcodes contain DNA, we are constantly adding new barcode libraries to unlock more scannable codes.",
            "Most QR codes will contain DNA and scanable monsters.",
            "Not all barcodes contain DNA, we are constantly adding new barcode libraries to unlock more scannable codes.",
            "We are trying to remove useless tips... but we keep adding more.",
            "Fetching monsters... please wait.",
            "The Global Monster Index shows all monsters created by players worldwide.",
            "Train your monsters daily to increase their strength.",
            "Different barcodes can yield different monster types.",
            "Challenge other players to climb the rankings!",
            "Combine DNA from different monsters to create new species!(Coming Soon)",
            "Your MVP monster gains bonus in battles!(Coming Soon)",
            "Check your monster collection daily for rewards!",
            "Scan barcodes to collect powerful items and unlock new abilities!(Coming Soon)",
            "Use your monster types wisely to overcome and defeat foes.",
            "The more barcodes you scan, the stronger your character becomes.(Maybe?)",
            "Each barcode you scan brings you closer to uncovering the game’s secrets.",
            "Some barcodes unlock special challenges that reward you with rare items.",
            "Scan bardcodes to extract DNA and create your unique monster team!",
            "Spend scanned DNA to create powerful upgrades and boost your stats!(Coming Soon)",
            "Don’t forget to manage your energy – scanning barcodes consumes it! (Maybe?)",
            "Be careful! Some barcodes may trigger traps or dangerous encounters.",
            "Discover the lore of Barcode Masters as you scan ancient barcodes scattered throughout the world.",
            "Look for hidden codes in the environment to unlock extra content and secrets.",
            "Training your monsters will give you an edge in battles.",
            "In play for keeps mode, you can win your opponents monster, or lose yours!",
            "All-in Mode: Risk it all by playing for keeps, put your monster up for bet and battle for the ultimate prize.",
            "Each barcode has a story – scan them all to piece together the mystery!",
            "Some barcodes for powerful boosts and unique abilities!",
            "Your adventure in Barcode Masters is filled with both danger and discovery.",
            "The monsters you create are unique to you – no two players will have the same monsters!",
            "Each monster is synthesized from the DNA of the barcodes you scan.",
            "Each monster is unique, it has its own appearence, strengths and weaknesses.",
            "As you progress, your scanning abilities evolve, unlocking new possibilities!",
            "The world of Barcode Masters is full of mysteries waiting to be uncovered with the right scan.",
            "Keep an eye on your scanner’s cooldown – timing is everything!",
            "Warning: Scanning barcodes may cause uncontrollable excitement.",
            "We know you’re here for the action, but don’t forget to read these tooltips... they’re here for your own good!",
            "This game doesn’t have any microtransactions... yet.",
            "Scan more barcodes...",
            "Your scanner is powered by pure curiosity. And maybe a little magic.",
            "This tooltip was added just for you, because we know you’ll read it.",
            "Not all tooltips are helpful... but they can be entertaining!",
            "Just when you thought scanning barcodes couldn’t get more exciting... it does. Probably.",
            "We hope this tooltip helps. If not, blame Canada",
            "If you think these tooltips are too long, just wait until you get the manual!",
            "Tip: Barcodes are actually the secret to life, the universe, and everything. Scan wisely.",
            "Don't worry, this tooltip won't spoil the plot... mostly because we haven't finished writing it.",
            "Did you know? 87% of players ignore tooltips. Don't be one of them!",
            "Just when you thought you were done with tutorials, here we are again.",
            "This tooltip is like the game itself – unexpected and full of surprises!",
            "Some say scanning barcodes is the key to greatness... others just say it's fun.",
            "Our developers are working hard to make this game better. We promise. Probably.",
            "Scan the barcode, get the reward. Or maybe a plot twist... we’ll see!",
            "This tooltip is for informational purposes only. No, seriously, we’re not sure what it means either.",
            "We put this tooltip here for comedic effect... hopefully it worked.",
            "Some barcodes lead to special bosses – defeat them for epic rewards!",
            "This game does not waste your time with 2-factor authentication. You’re welcome.",
            "Warming up the DNA extractor…",
            "Please stand by while we gather all the monster DNA you never asked for.", 
            "Making sure the monsters don’t break free… again. This time we promise it won’t happen.",
            "Updating leaderboard...",
            "Initiating world domination protocol… just kidding, we’re only fixing bugs.",
            "Preparing your scanner for the next big thing…",
            "Checking if all monsters are still behaving… so far, so good. We’ll update you if they start a rebellion.",
            "Leaderboard’s looking suspiciously quiet…",
            "Brief pause to upgrade your scanner… we’ve added a ‘snarky comment’ filter.",
            "Running diagnostics… we’re 99% sure the game is working as intended.",
            "Checking to make sure no monsters are hiding in the code…",
            "Powering up your scanner... hope it can handle all the awesome you’re about to scan.",
            "Scanning barcodes is like opening a box of chocolates… you never know what you’re gonna get.",     
            "Performing system update… we’re trying to make the game more fun...’",
            "Eventually we will add more game tips... but for now, just scan barcodes and have fun!",
        ];

        // Function to find highest level monster
        async function findMVPMonster(userId) {
            const db = getFirestore();
            const monstersRef = collection(db, "monsters");
            const q = query(monstersRef, where("ownerId", "==", userId)); // Changed from userId to ownerId
            
            try {
                const querySnapshot = await getDocs(q);
                let highestLevelMonster = null;
                console.log("Number of monsters found:", querySnapshot.size); // Debug log
                
                querySnapshot.forEach((doc) => {
                    const monster = doc.data();
                    console.log("Monster data:", monster); // Debug log
                    if (!highestLevelMonster || (monster.level || 0) > (highestLevelMonster.level || 0)) {
                        highestLevelMonster = {
                            ...monster,
                            id: doc.id
                        };
                    }
                });
                
                console.log("Highest level monster:", highestLevelMonster); // Debug log
                return highestLevelMonster;
            } catch (error) {
                console.error("Error fetching MVP monster:", error);
                return null;
            }
        }

        // Function to update MVP monster display
        function updateMVPMonster(monster) {
            console.log("Updating MVP monster display with:", monster); // Debug log
            if (monster && monster.monsterName) {  // Changed from name to monsterName
                document.getElementById('mvpMonsterName').textContent = monster.monsterName;  // Changed from name to monsterName
                document.getElementById('mvpMonsterWins').textContent = monster.wins || 0;
                document.getElementById('mvpMonsterXP').textContent = monster.experience || 0;
            } else {
                document.getElementById('mvpMonsterName').textContent = "No monsters yet";
                document.getElementById('mvpMonsterWins').textContent = "0";
                document.getElementById('mvpMonsterXP').textContent = "0";
            }
        }

        // Placeholder function to get MVP monster (to be connected to Firebase later)
        function updateMVPMonsterPlaceholder() {
            // This will be replaced with actual Firebase data later
            document.getElementById('mvpMonsterName').textContent = "Loading MVP data...";
            document.getElementById('mvpMonsterWins').textContent = "0";
            document.getElementById('mvpMonsterXP').textContent = "0";
        }

        // Function to update game tip
        function updateGameTip() {
            const tipElement = document.getElementById('gameTip');
            const randomTip = gameTips[Math.floor(Math.random() * gameTips.length)];
            tipElement.textContent = randomTip;
        }

        // Update tip every 10 seconds
        updateGameTip();
        setInterval(updateGameTip, 10000);

        // Function to show error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Function to handle logout
        async function handleLogout() {
            try {
                await signOut(auth);
                localStorage.removeItem("loggedInUser");
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error during sign-out:', error);
                showError('Failed to log out. Please try again.');
            }
        }

        // Handle logout button click
        document.getElementById('logoutButton').addEventListener('click', handleLogout);

        // Firebase Auth state check
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const db = getFirestore(app);
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    document.getElementById("userName").textContent = userData.username;
                    if (userData.profileImageUrl) {
                        document.getElementById('avatarPlaceholder').style.backgroundImage = `url(${userData.profileImageUrl})`;
                    }
                    // Find and display MVP monster
                    const mvpMonster = await findMVPMonster(user.uid);
                    updateMVPMonster(mvpMonster);

                    // Update player stats
                    await updatePlayerStats(user.uid);
                } else {
                    console.log("No such document!");
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // Function to fetch and update player stats
        async function updatePlayerStats(userId) {
            const db = getFirestore();
            const monstersRef = collection(db, "monsters");
            const q = query(monstersRef, where("ownerId", "==", userId));

            try {
                const querySnapshot = await getDocs(q);
                let totalMonsters = 0;
                let highestLevel = 0;
                const uniqueTypes = new Set();

                querySnapshot.forEach((doc) => {
                    const monster = doc.data();
                    totalMonsters++;
                    highestLevel = Math.max(highestLevel, monster.level || 0);
                    uniqueTypes.add(monster.type);
                });

                const totalTypes = (await getDocs(collection(db, "monsterTypes"))).size;
                const completionPercentage = ((uniqueTypes.size / totalTypes) * 100).toFixed(1);

                document.getElementById('totalMonsters').textContent = totalMonsters;
                document.getElementById('highestLevel').textContent = highestLevel;
                document.getElementById('uniqueTypes').textContent = uniqueTypes.size;
                document.getElementById('completionPercentage').textContent = `${completionPercentage}%`;
            } catch (error) {
                console.error("Error fetching player stats:", error);
            }
        }

        // Handle dark mode toggle
        const darkModeToggle = document.getElementById("darkModeToggle");
        const savedTheme = localStorage.getItem("theme");
        
        if (savedTheme === "dark") {
            document.body.classList.add("dark-mode");
        }

        darkModeToggle.addEventListener("click", function() {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
        });

        // Add this new profanity filter function
        function containsProfanity(text) {
            const profanityList = ["ass", "bitch", "damn", "fuck", "shit", "bastard", "crap", "dick", "piss", "pussy", "slut", "whore", "fag", "cunt", "hell", "moron", "idiot", "retard", "wanker","twat","penis","cock"];
            const regex = new RegExp(profanityList.join("|"), "i");
            return regex.test(text);
        }

        // Function to show error message as a toast
        function showToast(message, isError = false) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${isError ? 'rgba(231, 76, 60, 0.9)' : 'rgba(46, 204, 113, 0.9)'};
                    color: white;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    opacity: 0;
                    transition: all 0.3s ease;
                    z-index: 1000;
                `;
                document.body.appendChild(toast);
            } else {
                toast.style.background = isError ? 'rgba(231, 76, 60, 0.9)' : 'rgba(46, 204, 113, 0.9)';
            }

            toast.textContent = message;
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
            });

            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        // Function to rename player
        async function renamePlayer(userId, currentName) {
            try {
                const newName = prompt("Enter a new player name:", currentName);
                if (!newName || newName.trim() === "") return;

                // Check for profanity
                if (containsProfanity(newName)) {
                    showToast("The new name contains inappropriate language. Please choose a different name.", true);
                    return;
                }

                // Update the player's name in the database
                const userRef = doc(getFirestore(), "users", userId);
                await updateDoc(userRef, {
                    username: newName.trim()
                });

                // Update the displayed name
                document.getElementById("userName").textContent = newName.trim();
                showToast('Player renamed successfully!');
            } catch (error) {
                console.error("Error renaming player:", error);
                showToast("Failed to rename player: " + error.message, true);
            }
        }

        // Handle rename player button click
        document.getElementById('renamePlayerButton').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                const currentName = document.getElementById("userName").textContent;
                await renamePlayer(user.uid, currentName);
            }
        });

        // Function to handle profile image upload
        async function uploadProfileImage(file, userId) {
            const storageRef = ref(storage, `user-images/${userId}`);
            try {
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                await updateDoc(doc(getFirestore(), "users", userId), {
                    profileImageUrl: downloadURL
                });
                document.getElementById('avatarPlaceholder').style.backgroundImage = `url(${downloadURL})`;
                showToast('Profile photo updated successfully!');
            } catch (error) {
                console.error("Error uploading profile image:", error);
                showToast("Failed to upload profile image: " + error.message, true);
            }
        }

        // Handle upload image button click
        document.getElementById('uploadImageButton').addEventListener('click', () => {
            document.getElementById('profileImageInput').click();
        });

        // Handle file input change
        document.getElementById('profileImageInput').addEventListener('change', async (event) => {
            const user = auth.currentUser;
            if (user && event.target.files.length > 0) {
                const file = event.target.files[0];
                if (file.size > 2 * 1024 * 1024) { // Limit file size to 2MB
                    showToast("File size exceeds 2MB. Please choose a smaller file.", true);
                    return;
                }
                await uploadProfileImage(file, user.uid);
            }
        });
    </script>
</body>
</html>